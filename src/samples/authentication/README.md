# Authentication Sample

This sample demonstrates how to implement **Bearer Token authentication**. It shows how to intercept requests, validate tokens, extract the user generated by the authentication and pass it to the context.


## Key Components

- `index.ts`: generates an `AgentCard` that requires for the Bearer authentication for incoming requests and starts the server with the authentication middleware and user builder.
- `authentication_middleware.ts`: creates the middleware responsible for authentication. It uses Passport to support Bearer token authorization and populates the `user` parameter in the Request object with the plain extracted object.
- `user_builder.ts`: defines the callback for the user extraction. It expects the user object (populated by the middleware) to contain specific values (`email`, `userName`, `role`) which are used to build the `CustomUser` object.
- `agent_executor.ts`: creates a simple agent executor that checks the authentication status of the user object present in the context, which is expected to be an instance of `CustomUser` in case of successful authentication, and sends back the content.


To test the agent:

```bash
npm run agents:authentication-agent
```

The agent will start on `http://localhost:41241`.

Use this [tool](https://www.jwt.io/) to generate your Json Web Token with the JWT Encoder. The secret key for the signature is `a2a-secret-for-authentication-sample`.
For a successful authentication the payload data MUST contain these values: "email", "userName", "role".

```bash
curl -X POST http://localhost:41241/
    -H "Authorization: Bearer <jwt-token>"
    -H "Content-Type: application/json"
    -d '{
        "jsonrpc": "2.0",
        "id": 1,
        "method": "message/send",
        "params": {
            "message": {
            "role": "user",
            "parts": [
                {
                "kind": "text",
                "text": "Hello, who am i?"
                }
            ],
            "messageId": "9229e770-767c-417b-a0b0-f0741243c589"
            }
        }
    }'
```

Expected response, with successful authentication:
```json
    {
        "jsonrpc":"2.0",
        "id":1,
        "result": {
            "kind":"message",
            "role":"agent",
            "parts":[ {
                "kind":"text",
                "text":"The request is coming from the authenticated user <your-userName>, with email <your-email>  and role <your-role>." 
                } ]
            }
    }

```

Expected response, with failed authentication:
```json
    {
        "jsonrpc":"2.0",
        "id":1,
        "result": {
            "kind":"message",
            "role":"agent",
            "parts":[ {
                "kind":"text",
                "text":"The request is not coming from an authenticated user." 
                } ]
            }
    }

```
